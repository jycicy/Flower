version: '3.8' # 兼容你的 Docker Compose v2.29.2

services:
  # 1. MySQL 容器（自动下载 8.0 稳定版，无需手动安装）
  db:
    image: mysql:8.0 # 适配 Python 3.12 + django-mysqlclient 的稳定版本
    volumes:
      - mysql_data:/var/lib/mysql # 数据持久化：容器删除后数据不丢失
    environment:
      MYSQL_ROOT_PASSWORD: 112118 # 替换为你的密码（和 settings.py 一致）
      MYSQL_DATABASE: flower # 自动创建 flower 数据库，无需手动建库
      MYSQL_CHARSET: utf8mb4 # 支持 emoji 和特殊中文
      MYSQL_COLLATION: utf8mb4_unicode_ci
      # 解决 MySQL 8.0 密码认证兼容问题（适配 Django 旧版驱动）
      MYSQL_ROOT_HOST: '%'
      MYSQL_INITDB_SKIP_TZINFO: '1'
      CORS_ALLOWED_ORIGINS: "https://www.flowershop.com:8080,http://www.flowershop.com:8080"
    restart: always # 容器异常自动重启，保证服务稳定
    networks:
      - flower_network
    healthcheck:
      # 健康检查：确保 MySQL 启动完成后再启动 Django
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Django 容器（基于你优化后的 Dockerfile 构建）
  web:
    build: . # 自动构建 Django 镜像（包含 Python 3.12 + 项目依赖）
    volumes:
      - ./media:/app/media # 用户上传文件（如漂流卡照片）持久化到服务器
    depends_on:
      db:
        condition: service_healthy # 等待 MySQL 健康检查通过后再启动
    environment:
      DEBUG: "False"
      ALLOWED_HOSTS: "jycicy.top,localhost,127.0.0.1" # 替换为你的公网IP/域名
      MYSQL_ROOT_PASSWORD: your_mysql_password # 和上面 MySQL 密码一致
      SECRET_KEY: "django-insecure-j)*c)oxg#2i^q41ymqu6wk^3h3x(7mr#nrev21t#8=a*h#s2gm" # 从 settings.py 复制你的 SECRET_KEY
    restart: always
    networks:
      - flower_network
    # 限制资源（避免容器占用过多服务器资源，可选）
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # 3. Nginx 容器（自动下载 1.25 稳定版，无需手动安装）
  nginx:
    image: nginx:1.25 # 稳定版，适配静态资源转发
    ports:
      - "80:80" # 服务器 80 端口映射到容器，用户直接访问公网IP即可
      - "443:443" # HTTPS 端口（核心）
    volumes:
      # 挂载 Nginx 配置文件（本地 nginx/flower.conf → 容器内）
      - ./nginx/flower.conf:/etc/nginx/conf.d/default.conf
      # 挂载静态资源（Django 收集的 static_collected → Nginx）
      - static_volume:/app/static_collected
      # 共享媒体文件（和 Django 容器共用 media 目录）
      - ./media:/app/media
      # 证书目录挂载（新增！关键）
      - ./nginx/certs:/etc/nginx/certs
    depends_on:
      - web # 等待 Django 容器启动后再启动 Nginx
    restart: always
    networks:
      - flower_network

# 数据卷：持久化 MySQL 数据和静态资源（容器删除不丢失）
volumes:
  mysql_data:
  static_volume:

    # 自定义网络：隔离容器，提升安全性
networks:
  flower_network:
    driver: bridge
